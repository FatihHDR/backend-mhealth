# GitLab CI/CD Pipeline for Laravel Application
# This pipeline includes building, testing, code quality checks, and deployment stages

image: php:8.2-fpm

# Define pipeline stages
stages:
  - prepare
  - build
  - analyze
  - test
  - quality
  - security
  - report

# Cache dependencies for faster builds
cache:
  key:
    files:
      - composer.lock
      - package-lock.json
  paths:
    - vendor/
    - node_modules/
    - .npm/

# Global variables
variables:
  CACHE_DRIVER: array
  SESSION_DRIVER: array

# Template for PHP jobs
.php_base:
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libzip-dev libpq-dev libicu-dev libonig-dev libsqlite3-dev unzip
    - docker-php-ext-install pdo_mysql pdo_sqlite zip intl mbstring
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer --version

# Validate Composer files
composer:validate:
  extends: .php_base
  stage: prepare
  script:
    - composer validate --strict --no-check-publish
  allow_failure: false

# Install PHP dependencies
composer:install:
  extends: .php_base
  stage: build
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --optimize-autoloader
    - cp .env.example .env
    - php artisan key:generate
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 1 hour

# Install Node.js dependencies and build assets
npm:build:
  image: node:20
  stage: build
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    paths:
      - public/build/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/

# Code Style Check with Laravel Pint
code:style:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  variables:
    CACHE_DRIVER: array
  script:
    - ./vendor/bin/pint --test -v
  allow_failure: false

# Code Complexity Analysis
code:complexity:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - composer require --dev phpmetrics/phpmetrics -W
    - ./vendor/bin/phpmetrics --report-html=phpmetrics app/
  artifacts:
    paths:
      - phpmetrics/
    expire_in: 1 week
  allow_failure: true

# Dependency Analysis
dependencies:check:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - composer show --latest --direct
    - echo "Checking for outdated packages..."
    - composer outdated --direct || true
  allow_failure: true

# Database Schema Check
database:check:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - cp .env.example .env
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan migrate --pretend
    - echo "Migration check completed"
  allow_failure: true

# Static Analysis (Optional - requires larastan/phpstan)
# code:analysis:
#   extends: .php_base
#   stage: quality
#   dependencies:
#     - composer:install
#   script:
#     - ./vendor/bin/phpstan analyse
#   allow_failure: true

# Security Check
security:check:
  extends: .php_base
  stage: security
  dependencies:
    - composer:install
  script:
    - composer audit
  allow_failure: true

# Security - Check for secrets in code
security:secrets:
  image: python:3.11-slim
  stage: security
  before_script:
    - pip install detect-secrets
  script:
    - detect-secrets scan --baseline .secrets.baseline || true
    - echo "Secret scanning completed"
  allow_failure: true

# Coverage Report
test:coverage:
  extends: .php_base
  stage: report
  dependencies:
    - composer:install
  script:
    - cp .env.example .env
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan migrate --force --seed
    - php -dxdebug.mode=coverage ./vendor/bin/phpunit --coverage-text --coverage-html coverage/
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
    expire_in: 1 week
  allow_failure: true

# API Documentation Check
docs:api:
  extends: .php_base
  stage: report
  dependencies:
    - composer:install
  script:
    - cp .env.example .env
    - php artisan key:generate
    - php artisan route:list --json > routes.json
    - echo "API routes documented in routes.json"
  artifacts:
    paths:
      - routes.json
    expire_in: 1 week
  allow_failure: true

# PHPUnit Tests
phpunit:test:
  extends: .php_base
  stage: test
  dependencies:
    - composer:install
  script:
    - php -v
    - cp .env.example .env
    # Override database config untuk testing dengan SQLite
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan config:clear
    - php artisan migrate --force --seed
    - ./vendor/bin/phpunit --testdox --colors=never
  artifacts:
    when: always
    paths:
      - storage/logs/
    expire_in: 1 week
