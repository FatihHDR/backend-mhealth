# GitLab CI/CD Pipeline for Laravel Application
# This pipeline includes building, testing, code quality checks, and deployment stages

image: php:8.2-fpm

# Define pipeline stages
stages:
  - prepare
  - build
  - test
  - quality

# Cache dependencies for faster builds
cache:
  key:
    files:
      - composer.lock
      - package-lock.json
  paths:
    - vendor/
    - node_modules/
    - .npm/

# Global variables
variables:
  CACHE_DRIVER: array
  SESSION_DRIVER: array

# Template for PHP jobs
.php_base:
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libzip-dev libpq-dev libicu-dev libonig-dev libsqlite3-dev unzip
    - docker-php-ext-install pdo_mysql pdo_sqlite zip intl mbstring
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer --version

# Validate Composer files
composer:validate:
  extends: .php_base
  stage: prepare
  script:
    - composer validate --strict --no-check-publish
  allow_failure: false

# Install PHP dependencies
composer:install:
  extends: .php_base
  stage: build
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --optimize-autoloader
    - cp .env.example .env
    - php artisan key:generate
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 1 hour

# Install Node.js dependencies and build assets
npm:build:
  image: node:20
  stage: build
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    paths:
      - public/build/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/

# Code Style Check with Laravel Pint
code:style:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  variables:
    CACHE_DRIVER: array
  script:
    - ./vendor/bin/pint --test -v
  allow_failure: false

# Static Analysis (Optional - requires larastan/phpstan)
# code:analysis:
#   extends: .php_base
#   stage: quality
#   dependencies:
#     - composer:install
#   script:
#     - ./vendor/bin/phpstan analyse
#   allow_failure: true

# Security Check
security:check:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  script:
    - composer audit
  allow_failure: true

# PHPUnit Tests
phpunit:test:
  extends: .php_base
  stage: test
  dependencies:
    - composer:install
  script:
    - php -v
    - cp .env.example .env
    # Override database config untuk testing dengan SQLite
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan config:clear
    - php artisan migrate --force --seed
    - ./vendor/bin/phpunit --testdox --colors=never
  artifacts:
    when: always
    paths:
      - storage/logs/
    expire_in: 1 week
