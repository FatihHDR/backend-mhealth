# GitLab CI/CD Pipeline for Laravel Application
# This pipeline includes building, testing, code quality checks, and deployment stages

image: php:8.2-fpm

# Define pipeline stages
stages:
  - prepare
  - build
  - test
  - quality
  - deploy

# Cache dependencies for faster builds
cache:
  key:
    files:
      - composer.lock
      - package-lock.json
  paths:
    - vendor/
    - node_modules/
    - .npm/

# Global variables
variables:
  MYSQL_DATABASE: laravel_test
  MYSQL_ROOT_PASSWORD: secret
  DB_HOST: mysql
  DB_USERNAME: root

# Template for PHP jobs
.php_base:
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libzip-dev libpq-dev libicu-dev libonig-dev unzip
    - docker-php-ext-install pdo_mysql zip intl mbstring
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer --version

# Validate Composer files
composer:validate:
  extends: .php_base
  stage: prepare
  script:
    - composer validate --strict --no-check-publish
  allow_failure: false

# Install PHP dependencies
composer:install:
  extends: .php_base
  stage: build
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
    - cp .env.example .env
    - php artisan key:generate
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 1 hour

# Install Node.js dependencies and build assets
npm:build:
  image: node:20
  stage: build
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    paths:
      - public/build/
      - node_modules/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/

# Code Style Check with Laravel Pint
code:style:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  script:
    - ./vendor/bin/pint --test -v
  allow_failure: false

# Static Analysis (Optional - requires larastan/phpstan)
# code:analysis:
#   extends: .php_base
#   stage: quality
#   dependencies:
#     - composer:install
#   script:
#     - ./vendor/bin/phpstan analyse
#   allow_failure: true

# Security Check
security:check:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  script:
    - composer audit
  allow_failure: true

# PHPUnit Tests
phpunit:test:
  extends: .php_base
  stage: test
  services:
    - mysql:8.0
  dependencies:
    - composer:install
  script:
    - php -v
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:clear
    - php artisan cache:clear
    - php artisan migrate --force
    - php artisan db:seed --force
    - ./vendor/bin/phpunit --testdox --colors=never --coverage-text --coverage-cobertura=coverage.cobertura.xml
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.cobertura.xml
    paths:
      - storage/logs/
    expire_in: 1 week

# Deploy to Staging
deploy:staging:
  stage: deploy
  environment:
    name: staging
    url: https://staging.yourdomain.com
  only:
    - develop
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying to staging server..."
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && git pull origin develop"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && composer install --no-dev --optimize-autoloader"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && php artisan migrate --force"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && php artisan config:cache"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && php artisan route:cache"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && php artisan view:cache"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd $STAGING_PATH && php artisan queue:restart"
  when: manual

# Deploy to Production
deploy:production:
  stage: deploy
  environment:
    name: production
    url: https://yourdomain.com
  only:
    - main
    - master
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server..."
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && git pull origin main"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && composer install --no-dev --optimize-autoloader"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan migrate --force"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan config:cache"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan route:cache"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan view:cache"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan queue:restart"
    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER_IP "cd $PRODUCTION_PATH && php artisan octane:reload"
  when: manual
