# GitLab CI/CD Pipeline for Laravel Application
# Includes Docker build, testing, and push to GitLab Container Registry

image: php:8.4-fpm

# Define pipeline stages
stages:
  - prepare
  - build
  - analyze
  - test
  - quality
  - security
  - docker
  - report
  - deploy

# Cache dependencies for faster builds
cache:
  key:
    files:
      - composer.lock
      - package-lock.json
  paths:
    - vendor/
    - node_modules/
    - .npm/

# Global variables
variables:
  CACHE_DRIVER: array
  SESSION_DRIVER: array
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# Template for PHP jobs
.php_base:
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libzip-dev libpq-dev libicu-dev libonig-dev libsqlite3-dev unzip postgresql-client
    - docker-php-ext-install pdo_mysql pdo_pgsql pdo_sqlite zip intl mbstring
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer --version

# Validate Composer files
composer:validate:
  extends: .php_base
  stage: prepare
  script:
    - composer validate --strict --no-check-publish
  allow_failure: false

# Install PHP dependencies
composer:install:
  extends: .php_base
  stage: build
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --optimize-autoloader
    - cp .env.example .env
    - php artisan key:generate
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 1 hour

# Install Node.js dependencies and build assets
npm:build:
  image: node:20
  stage: build
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    paths:
      - public/build/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/

# Code Style Check with Laravel Pint
code:style:
  extends: .php_base
  stage: quality
  dependencies:
    - composer:install
  variables:
    CACHE_DRIVER: array
  script:
    - ./vendor/bin/pint --test -v
  allow_failure: false

# Code Complexity Analysis
code:complexity:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - composer require --dev phpmetrics/phpmetrics -W
    - ./vendor/bin/phpmetrics --report-html=phpmetrics app/
  artifacts:
    paths:
      - phpmetrics/
    expire_in: 1 week
  allow_failure: true

# Dependency Analysis
dependencies:check:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - composer show --latest --direct
    - echo "Checking for outdated packages..."
    - composer outdated --direct || true
  allow_failure: true

# Database Schema Check
database:check:
  extends: .php_base
  stage: analyze
  dependencies:
    - composer:install
  script:
    - cp .env.example .env
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan migrate --pretend
    - echo "Migration check completed"
  allow_failure: true

# Static Analysis (Optional - requires larastan/phpstan)
# code:analysis:
#   extends: .php_base
#   stage: quality
#   dependencies:
#     - composer:install
#   script:
#     - ./vendor/bin/phpstan analyse
#   allow_failure: true

# Security Check
security:check:
  extends: .php_base
  stage: security
  dependencies:
    - composer:install
  script:
    - composer audit
  allow_failure: true

# Security - Check for secrets in code
security:secrets:
  image: python:3.11-slim
  stage: security
  before_script:
    - pip install detect-secrets
  script:
    - detect-secrets scan --baseline .secrets.baseline || true
    - echo "Secret scanning completed"
  allow_failure: true

# Coverage Report
test:coverage:
  extends: .php_base
  stage: report
  dependencies:
    - composer:install
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libzip-dev libpq-dev libicu-dev libonig-dev libsqlite3-dev unzip
    - docker-php-ext-install pdo_mysql pdo_sqlite zip intl mbstring
    # Install Xdebug for code coverage
    - pecl install xdebug
    - docker-php-ext-enable xdebug
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - cp .env.example .env
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=:memory:" >> .env
    - php artisan key:generate
    - php artisan migrate --force --seed
    - php -dxdebug.mode=coverage ./vendor/bin/phpunit --coverage-text --coverage-html coverage/ --coverage-cobertura coverage/cobertura.xml
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
    expire_in: 1 week
  allow_failure: true

# API Documentation Check
docs:api:
  extends: .php_base
  stage: report
  dependencies:
    - composer:install
  script:
    - cp .env.example .env
    - php artisan key:generate
    - php artisan route:list --json > routes.json
    - echo "API routes documented in routes.json"
  artifacts:
    paths:
      - routes.json
    expire_in: 1 week
  allow_failure: true

# PHPUnit Tests
phpunit:test:
  extends: .php_base
  stage: test
  dependencies:
    - composer:install
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: laravel
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: password
  script:
    - php -v
    - cp .env.example .env
    # Use PostgreSQL for CI (migrations generated for Postgres)
    - echo "DB_CONNECTION=pgsql" >> .env
    - echo "DB_HOST=postgres" >> .env
    - echo "DB_PORT=5432" >> .env
    - echo "DB_DATABASE=laravel" >> .env
    - echo "DB_USERNAME=postgres" >> .env
    - echo "DB_PASSWORD=password" >> .env
    - echo "Waiting for Postgres to be ready..."
    - for i in {1..15}; do pg_isready -h postgres -p 5432 && break || sleep 1; done
    - php artisan key:generate
    - php artisan config:clear
    - php artisan migrate --force --seed
    - ./vendor/bin/phpunit --testdox --colors=never

# ============================================
# Docker Build and Push to Container Registry
# ============================================

# Build Docker image and push to GitLab Container Registry
docker:build:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image for commit $CI_COMMIT_SHORT_SHA..."
    - docker build --pull --cache-from $IMAGE_LATEST --tag $IMAGE_TAG --tag $IMAGE_LATEST --file Dockerfile .
    - echo "Pushing to GitLab Container Registry..."
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
    - echo "Image pushed successfully"
    - echo "Tagged as $IMAGE_TAG"
    - echo "Tagged as $IMAGE_LATEST"
  only:
    - main
    - master
    - develop
    - tags
  tags:
    - docker
  needs:
    - composer:install
    - npm:build

# Build Docker images for feature branches
docker:build-feature:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - export FEATURE_TAG=$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - echo "Building feature branch image $FEATURE_TAG"
    - docker build --tag $FEATURE_TAG .
    - docker push $FEATURE_TAG
    - echo "Feature image pushed $FEATURE_TAG"
  except:
    - main
    - master
    - develop
    - tags
  when: manual
  tags:
    - docker

# Push to Docker Hub (requires DOCKERHUB_USERNAME and DOCKERHUB_TOKEN in CI variables)
docker:push-dockerhub:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - export DOCKERHUB_IMAGE=docker.io/$DOCKERHUB_USERNAME/backend-mhealth
    - echo "Building and pushing to Docker Hub - $DOCKERHUB_IMAGE"
    - docker build --tag $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA --tag $DOCKERHUB_IMAGE:latest .
    - docker push $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKERHUB_IMAGE:latest
    - echo "Pushed to Docker Hub"
    - echo "  $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA"
    - echo "  $DOCKERHUB_IMAGE:latest"
  only:
    - main
    - master
    - tags
  tags:
    - docker
  needs:
    - composer:install
    - npm:build


# ============================================
# Deployment (Optional - Customize as needed)
# ============================================

# Deploy to staging/production
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl git
  script:
    - echo "Deploying image $IMAGE_TAG to production..."
    - echo "Image ready at $CI_REGISTRY_IMAGE"
    # Add your deployment commands here:
    # Example: SSH to server and pull the image
    # - ssh user@server "docker pull $IMAGE_TAG && docker-compose up -d"
    # Example: Update Kubernetes deployment
    # - kubectl set image deployment/laravel-app app=$IMAGE_TAG
    # Example: Trigger deployment webhook
    # - curl -X POST $DEPLOY_WEBHOOK_URL -H "Authorization: Bearer $DEPLOY_TOKEN"
  environment:
    name: production
    url: https://your-app-domain.com
  only:
    - main
    - master
  when: manual
  needs:
    - docker:build
  tags:
    - docker
  artifacts:
    when: always
    paths:
      - storage/logs/
    expire_in: 1 week
